{"title":"借助云主机，在外也能访问家中的Home Assistant","date":"2023-08-02T17:35:55.000Z","date_formatted":{"ll":"Aug 3, 2023","L":"08/03/2023","MM-DD":"08-03"},"author":"Ward","thumbnail":"https://cdn.wardzhou.art/img/Screenshot%202023-08-04%20at%2019.55.52.webp","link":"2023/08/03/ha-frp","comments":true,"tags":["HomeAssistant","Linux","Nginx","SmartHome"],"categories":["教程"],"updated":"2024-01-24T16:56:18.136Z","content":"<p>Home Assistant (HA)，靠其强大的功能、可拓展性、和社区支持，得到了很多智能家居爱好者的青睐。而在内地复杂的宽带环境下，如何在局域网外访问HA成为最大的痛点之一。如果你正巧有自己的域名和云服务器，那么这篇指南可能是个不错的选择。</p>\n<p>Updated on Aug. 23 —— 增加frpc服务连接失败自动重连配置</p>\n<blockquote>\n<p><strong>10秒速读：本文通过FRP在服务器端和客户端搭建通道，并通过Nginx反向代理来实现自定义域名访问家中的HA实例。</strong></p>\n<p>环境：Linux</p>\n<p>需要准备：</p>\n<ul>\n<li>有公网IP的云服务器，并预装Linux系统；</li>\n<li>通过<a href=\"https://www.home-assistant.io/installation/linux\" target=\"_blank\">原生OS/Supervisor</a>方式部署好的HA客户端（VM或者Docker可能会有未知问题）</li>\n<li>一些耐心</li>\n</ul>\n</blockquote>\n<h2 id=\"1.服务器端配置\">1.服务器端配置<a title=\"#1.服务器端配置\" href=\"#1.服务器端配置\"></a></h2>\n<h3 id=\"1.1下载\">1.1下载<a title=\"#1.1下载\" href=\"#1.1下载\"></a></h3>\n<p>FRP软件包包含两部分：服务器端的FRPS和客户端的FRPC，该软件包提供跨平台支持，所以需要确定你服务器的架构。使用下面的命令输出：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">uname</span> -m</span><br></pre></td></tr></table></figure>\n<p>在下面的链接（可能需要魔法访问）复制对应架构的最新版的链接：</p>\n<p><a href=\"https://github.com/fatedier/frp/releases\" target=\"_blank\">Releases · fatedier/frp (github.com)</a></p>\n<p>下面amd64为例</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /home/</span><br><span class=\"line\"><span class=\"comment\"># 下载</span></span><br><span class=\"line\">wget https://github.com/fatedier/frp/releases/download/v0.51.2/frp_0.51.2_linux_amd64.tar.gz</span><br><span class=\"line\"><span class=\"comment\"># 创建文件夹解压</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> frp</span><br><span class=\"line\">tar -xzf frp_0.51.2_linux_amd64.tar.gz -C frp</span><br><span class=\"line\"><span class=\"comment\"># 进入目录</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> frp/frp_0.51.2_linux_amd64/</span><br></pre></td></tr></table></figure>\n<h3 id=\"1.2配置frps\">1.2配置FRPS<a title=\"#1.2配置frps\" href=\"#1.2配置frps\"></a></h3>\n<p>修改配置文件 <code>frps.ini</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vim  frps.ini</span><br></pre></td></tr></table></figure>\n<p>文件内容：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[common]</span></span><br><span class=\"line\"><span class=\"attr\">bind_port</span> = <span class=\"number\">7000</span></span><br><span class=\"line\"><span class=\"attr\">vhost_http_port</span> = <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">auto_token</span> = <span class=\"number\">123456</span></span><br></pre></td></tr></table></figure>\n<p>vim文件编辑器内输入<code>i</code>进入编辑模式。</p>\n<p><code>bind_port</code>是需要绑定的服务器端口，<code>vhost_http_port</code>是你希望通过服务器访问的端口，需要提前确认这两个端口没有被占用</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查询端口占用</span></span><br><span class=\"line\">netstat -ntlp</span><br></pre></td></tr></table></figure>\n<p><code>auto_token</code>是用来认证的密钥，可以自定义</p>\n<p>配置完成后，按ESC退出编辑模式，输入<code>:w</code>并按回车，紧接着输入<code>:q</code>并按回车保存退出</p>\n<h3 id=\"1.3配置开机自启\">1.3配置开机自启<a title=\"#1.3配置开机自启\" href=\"#1.3配置开机自启\"></a></h3>\n<p>创建一个服务，便于管理并随开机自动运行</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo <span class=\"built_in\">cp</span> frps /usr/local/bin/frps</span><br><span class=\"line\">sudo <span class=\"built_in\">mkdir</span> /etc/frp/  </span><br><span class=\"line\">sudo <span class=\"built_in\">cp</span> frps.ini /etc/frp/frps.ini </span><br><span class=\"line\">sudo vim /etc/systemd/system/frps.service</span><br></pre></td></tr></table></figure>\n<p>创建服务配置文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\"># 服务名称，可自定义</span><br><span class=\"line\">Description = frp server</span><br><span class=\"line\">After = network.target syslog.target</span><br><span class=\"line\">Wants = network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type = simple</span><br><span class=\"line\"># 启动frps的命令，需修改为您的frps的安装路径</span><br><span class=\"line\">ExecStart=/usr/local/bin/frps -c /etc/frp/frps.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy = multi-user.target</span><br></pre></td></tr></table></figure>\n<p>编辑和保存命令同上</p>\n<p>开启服务，并配置开机启动</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start frps</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> frps</span><br></pre></td></tr></table></figure>\n<p>查看是否运行成功</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl status frps</span><br></pre></td></tr></table></figure>\n<p>云服务器一般有安全管理，需要去控制台开放端口，示例里为<code>7000</code>和<code>9000</code>这两个端口。如果你希望通过Nginx反向代理，那么只开放<code>7000</code>就可以了。</p>\n<h2 id=\"2.客户端配置\">2.客户端配置<a title=\"#2.客户端配置\" href=\"#2.客户端配置\"></a></h2>\n<h3 id=\"2.1-下载\">2.1 下载<a title=\"#2.1-下载\" href=\"#2.1-下载\"></a></h3>\n<p>同样的，我们需要下载frp，并配置frpc的部分运行，请注意与第一部的命令区分</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">uname</span> -m</span><br></pre></td></tr></table></figure>\n<p>在下面的链接（可能需要魔法访问）复制对应架构的最新版的链接：</p>\n<p><a href=\"https://github.com/fatedier/frp/releases\" target=\"_blank\">Releases · fatedier/frp (github.com)</a></p>\n<p>下面<strong>arm</strong>为例</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /home/</span><br><span class=\"line\"><span class=\"comment\"># 下载</span></span><br><span class=\"line\">wget https://github.com/fatedier/frp/releases/download/v0.51.2/frp_0.51.2_linux_arm64.tar.gz</span><br><span class=\"line\"><span class=\"comment\"># 创建文件夹解压</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> frp</span><br><span class=\"line\">tar -xzf frp_0.51.2_linux_arm64.tar.gz -C frp</span><br><span class=\"line\"><span class=\"comment\"># 进入目录</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> frp/frp_0.51.2_linux_arm64/</span><br></pre></td></tr></table></figure>\n<h3 id=\"2.2-配置frpc\">2.2 配置FRPC<a title=\"#2.2-配置frpc\" href=\"#2.2-配置frpc\"></a></h3>\n<p>修改frpc的配置文件</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vim frpc.ini</span><br></pre></td></tr></table></figure>\n<p>文件内配置，需要注意，和<code>bind_port</code>要一致，<code>auto_token</code>也一样。</p>\n<p><code>local_ip</code>为设备的内网IP，如<code>192.168.0.122</code></p>\n<p><code>local_port</code>是HA内网访问的端口号，默认为<code>8123</code></p>\n<p><code>remote_port</code>为服务器端要访问的端口号，和<code>vhost_http_port</code>保持一致</p>\n<p>⚠️<code>login_fail_exit = false</code> 这里非常重要，否则中途网络出现问题，frpc服务会自动终止，不能尝试自动重连！</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[common]</span></span><br><span class=\"line\"><span class=\"attr\">tls_enable</span> = <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">server_addr</span> = 云服务器IP</span><br><span class=\"line\"><span class=\"attr\">server_port</span> = <span class=\"number\">7000</span></span><br><span class=\"line\"><span class=\"attr\">auto_token</span> = <span class=\"number\">123456</span></span><br><span class=\"line\"><span class=\"attr\">login_fail_exit</span> = <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[VNC1]</span></span><br><span class=\"line\"><span class=\"attr\">type</span> = http</span><br><span class=\"line\"><span class=\"attr\">local_ip</span> = <span class=\"number\">192.168</span>.<span class=\"number\">0.122</span></span><br><span class=\"line\"><span class=\"attr\">local_port</span> = <span class=\"number\">8123</span></span><br><span class=\"line\"><span class=\"attr\">remote_port</span> = <span class=\"number\">9000</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"2.3配置开机自启\">2.3配置开机自启<a title=\"#2.3配置开机自启\" href=\"#2.3配置开机自启\"></a></h3>\n<p>创建服务，便于管理并随开机自动运行</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo <span class=\"built_in\">cp</span> frpc /usr/local/bin/frpc</span><br><span class=\"line\">sudo <span class=\"built_in\">mkdir</span> /etc/frp/  </span><br><span class=\"line\">sudo <span class=\"built_in\">cp</span> frpc.ini /etc/frp/frpc.ini </span><br><span class=\"line\">sudo vim /etc/systemd/system/frpc.service</span><br></pre></td></tr></table></figure>\n<p>创建<code>frpc.service</code>文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\"># 服务名称，可自定义</span><br><span class=\"line\">Description = frp server</span><br><span class=\"line\">After = network.target syslog.target</span><br><span class=\"line\">Wants = network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type = simple</span><br><span class=\"line\"># 启动frpc的命令，需修改为您的frpc的安装路径</span><br><span class=\"line\">ExecStart=/usr/local/bin/frpc -c /etc/frp/frpc.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy = multi-user.target</span><br></pre></td></tr></table></figure>\n<p>开启服务，并配置开机启动</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start frpc</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> frpc</span><br></pre></td></tr></table></figure>\n<p>查看是否运行成功</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl status frpc</span><br></pre></td></tr></table></figure>\n<h2 id=\"3.配置ha\">3.配置HA<a title=\"#3.配置ha\" href=\"#3.配置ha\"></a></h2>\n<p>此时通过云服务器+<code>9000</code>端口就能打开页面了，如果显示400错误，不用担心，是因为HA有额外的安全设置，需要把代理地址加入白名单才能正常在局域网外访问。</p>\n<p>首先通过插件市场安装File editor用来编辑<code>/config/configuration.yaml</code>配置文件</p>\n<p>在结尾添加配置：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http:</span><br><span class=\"line\">  base_url: https://your url #外网域名或IP</span><br><span class=\"line\">  cors_allowed_origins: https:///your url #外网域名或IP</span><br><span class=\"line\">  use_x_forwarded_for: true</span><br><span class=\"line\">  trusted_proxies:</span><br><span class=\"line\">    - 47.103.129.118 #外网IP</span><br><span class=\"line\">    - 10.0.0.106 #内网IP</span><br><span class=\"line\">    - 172.18.0.1 #本机地址</span><br></pre></td></tr></table></figure>\n<p>进入设置，验证<code>configuration.yaml</code>是否能通过，如果不能通过，请仔细检查格式，如果能通过，选择完全重启HA。</p>\n<p>重启后，通过云服务器的域名/IP+端口应该可以直接访问。</p>\n<p>如果不需要自定义域名来访问，那么本教程已经到此结束，休息一下来杯可乐奖励自己！</p>\n<h2 id=\"4.nginx反向代理\">4.Nginx反向代理<a title=\"#4.nginx反向代理\" href=\"#4.nginx反向代理\"></a></h2>\n<p>这部分将带你为HA转发的服务套一层域名“马甲”。需要使用的软件为Nginx Proxy Manager，安装教程可以参考我之前发的这篇：</p>\n<p><a href=\"https://wardzhou.art/2021/02/27/NginXProxyManager\" target=\"_blank\">Nginx Proxy Manager——小而美的多容器转发方案 - 白桦 Birch (wardzhou.art)</a></p>\n<p>首先在域名提供商进行解析，创建新的A记录指向你设置的公网IP。这里使用二级域名或者顶级域名都是可以的。</p>\n<p>然后登陆Nginx Proxy Manager的Dashboard，创建新的Proxy，填写内网的IP，这里的获取方式在上述链接中有所提及。</p>\n<p><code>Domin Names</code>填写刚刚设置的外网地址，选择http，然后切换到<code>ssl</code>选项，申请https证书，稍等证书下发后勾选需要的选项保存。</p>\n<p>此时就可以通过你设置的域名登陆HA啦！</p>\n<p>如果你使用HA的官方APP的话，建议去设置一下外部访问的网址，并把内网的IP与家里的Wi-Fi名绑定，这样就能自动切换，在家访问更快。</p>\n<p>此时<code>vhost_http_port</code>这个端口已经不再需要了，可以去云服务器的安全组关掉。不需要的端口关掉更为安全。</p>\n<blockquote>\n<p>参考</p>\n<ol>\n<li><a href=\"https://www.cnblogs.com/feiyunhongge/p/17464922.html\" target=\"_blank\">树莓派+阿里云+frp 实现内网穿透 - brilliant_999 - 博客园 (cnblogs.com)</a></li>\n<li><a href=\"https://wardzhou.art/2021/02/27/NginXProxyManager\" target=\"_blank\">Nginx Proxy Manager——小而美的多容器转发方案 - 白桦 Birch (wardzhou.art)</a></li>\n<li><a href=\"https://community.home-assistant.io/t/home-assistant-400-bad-request-docker-proxy-solution/322163\" target=\"_blank\">Home assistant (400 Bad Request) Docker + Proxy - Solution - Configuration - Home Assistant Community (home-assistant.io)</a></li>\n<li><a href=\"https://github.com/fatedier/frp/issues/2605\" target=\"_blank\">第一次链接服务器若网络不可用，则frpc会直接退出。 · Issue #2605 · fatedier/frp · GitHub</a></li>\n</ol>\n</blockquote>\n","prev":{"title":"Xiaomi 13 Ultra sample shots in Hong Kong","link":"2023/12/31/Xiaomi-13-Ultra-HK"},"next":{"title":"Hue","link":"2022/08/07/Hue"},"plink":"http://wardzhou.art/2023/08/03/ha-frp/","toc":[{"id":"1.服务器端配置","title":"1.服务器端配置","index":"1","children":[{"id":"1.1下载","title":"1.1下载","index":"1.1"},{"id":"1.2配置frps","title":"1.2配置FRPS","index":"1.2"},{"id":"1.3配置开机自启","title":"1.3配置开机自启","index":"1.3"}]},{"id":"2.客户端配置","title":"2.客户端配置","index":"2","children":[{"id":"2.1-下载","title":"2.1 下载","index":"2.1"},{"id":"2.2-配置frpc","title":"2.2 配置FRPC","index":"2.2"},{"id":"2.3配置开机自启","title":"2.3配置开机自启","index":"2.3"}]},{"id":"3.配置ha","title":"3.配置HA","index":"3"},{"id":"4.nginx反向代理","title":"4.Nginx反向代理","index":"4"}],"reward":true,"copyright":{"author":"Ward","license":"Attribution-NonCommercial-NoDerivatives 4.0 International(<a href=\"https://creativecommons.org/licenses/by-nc-nd/4.0/\" rel=\\\"external nofollow\\\" target=\\\"_blank\\\">CC BY-NC-ND 4.0</a>)","updated":"January 25, 2024"},"reading_time":"1850 words in 12 min"}